name: Render Keepalive

on:
  schedule:
    - cron: '*/5 * * * *'
  workflow_dispatch: {}   # optional: allows manual run from UI

jobs:
  ping:
    runs-on: ubuntu-latest
    steps:
      - name: Ping Render apps (with retries and timeout)
        run: |
          set -euo pipefail
          urls=(
            "https://infovault-1.onrender.com/"
            "https://youtube-learning-manager.vercel.app/"
            "https://youtube-learning-manager.onrender.com/keepalive"
          )

          for url in "${urls[@]}"; do
            echo "===> $(date -u +"%Y-%m-%d %H:%M:%S UTC") - pinging $url"
            success=0
            tries=0
            max_tries=3

            while [ $tries -lt $max_tries ]; do
              tries=$((tries+1))
              # -f : fail on HTTP error codes (4xx/5xx)
              # --max-time 10 : timeout in seconds
              # -I : HEAD would be lighter, but we use GET by default (no -I)
              # -sS : silent but show errors
              http_status=$(curl -sS -o /dev/null -w "%{http_code}" --max-time 10 -L "$url") || rc=$?
              rc=${rc:-0}
              echo "  try #$tries -> HTTP status: $http_status, exit: $rc"
              if [ "$rc" -eq 0 ] && [ "${http_status:0:1}" != "5" ]; then
                success=1
                break
              fi
              sleep 2
            done

            if [ $success -eq 0 ]; then
              echo "ERROR: $url failed after $max_tries tries"
              exit 1
            fi
          done
