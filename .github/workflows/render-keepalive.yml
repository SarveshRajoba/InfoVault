name: Render Keepalive

on:
  schedule:
    - cron: "*/5 * * * *"
  workflow_dispatch: {}

jobs:
  ping:
    runs-on: ubuntu-latest
    steps:
      - name: Ping Render apps safely
        run: |
          set -euo pipefail
          urls=(
          "https://infovault-ktyl.onrender.com"
            "https://infovault-1.onrender.com/"
            "https://youtube-learning-manager.vercel.app/"
            "https://youtube-learning-manager.onrender.com/keepalive"
            "https://youtube-learning-manager-7d42.onrender.com"
          )

          for url in "${urls[@]}"; do
            echo "===> $(date -u +"%Y-%m-%d %H:%M:%S UTC") - pinging $url"

            # Longer timeout for Render (cold boots are slow)
            if [[ "$url" == *"onrender.com"* ]]; then
              timeout=25
            else
              timeout=10
            fi

            success=0
            tries=0
            max_tries=3

            while [ $tries -lt $max_tries ]; do
              tries=$((tries+1))

              http_status=$(curl -I -sS -o /dev/null -w "%{http_code}" --max-time $timeout -L "$url" || echo "000")
              echo "  try #$tries -> HTTP: $http_status"

              # Success if not 5xx
              if [[ "$http_status" != 5* && "$http_status" != "000" ]]; then
                success=1
                break
              fi

              sleep 3
            done

            if [ $success -eq 0 ]; then
              echo "WARNING: $url failed after $max_tries tries â€” continuing"
            fi
          done
